<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³½æ¶¦ä¹ç¦AIåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            neutral: {
              100: '#F3F4F6',
              200: '#E5E7EB',
              300: '#D1D5DB',
              400: '#9CA3AF',
              500: '#6B7280',
              600: '#4B5563',
              700: '#374151',
              800: '#1F2937',
              900: '#111827',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .chat-height {
        height: clamp(400px, 100vh, 700px);
      }
      .chat-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      }
      .message-appear {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .float-animation {
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .bounce-hover {
        transition: transform 0.2s ease;
      }
      .bounce-hover:hover {
        transform: translateY(-5px) scale(1.05);
      }
      .fullscreen-chat {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        max-width: 100% !important;
        border-radius: 0 !important;
        z-index: 9999 !important;
      }
      .typing-indicator {
        display: inline-block;
        overflow: hidden;
        vertical-align: bottom;
        animation: typing 1.5s steps(4, end) infinite;
      }
      @keyframes typing {
        from { width: 0 }
        to { width: 1.5em }
      }
      .markdown-content {
        @apply text-sm text-neutral-800 leading-relaxed;
      }
      .markdown-content p {
        @apply mb-2;
      }
      .markdown-content ul {
        @apply list-disc pl-5 mb-2;
      }
      .markdown-content ol {
        @apply list-decimal pl-5 mb-2;
      }
      .markdown-content li {
        @apply mb-1;
      }
      .markdown-content strong {
        @apply font-bold;
      }
      .markdown-content a {
        @apply text-primary hover:underline;
      }
      .markdown-content h4 {
        @apply font-semibold mb-1;
      }
      .markdown-content h5 {
        @apply font-medium mb-1;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <!-- AIèŠå¤©çª—å£ -->
  <div id="chat-window" class="fixed inset-0 bg-white rounded-xl shadow-xl chat-shadow overflow-hidden z-40">
    <div class="bg-primary text-white p-4 flex items-center justify-between">
      <div class="flex items-center">
        <div class="relative mr-3">
          <img src="https://picsum.photos/40/40?random=ai" alt="æ³½æ¶¦ä¹ç¦AIåŠ©æ‰‹å¤´åƒ" class="w-10 h-10 rounded-full border-2 border-white">
          <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
        </div>
        <div>
          <h3 class="font-medium">æ³½æ¶¦ä¹ç¦AIåŠ©æ‰‹</h3>
          <p class="text-xs opacity-80">éšæ—¶ä¸ºæ‚¨æœåŠ¡</p>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <button id="toggle-fullscreen" class="text-white hover:text-gray-200 transition-colors">
          <i class="fa fa-compress"></i>
        </button>
        <button id="close-chat" class="text-white hover:text-gray-200 transition-colors">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>
    
    <div id="chat-messages" class="chat-height overflow-y-auto p-4 space-y-4 bg-gray-50">
      <!-- æ¬¢è¿æ¶ˆæ¯ -->
      <div class="flex items-start message-appear">
        <img src="https://picsum.photos/40/40?random=ai" alt="AIåŠ©æ‰‹å¤´åƒ" class="w-8 h-8 rounded-full mr-2 mt-1">
        <div class="bg-white rounded-lg p-3 max-w-[80%] shadow-sm">
          <div class="markdown-content">
            <p>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ³½æ¶¦ä¹ç¦AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</p>
            <p>æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹æ–¹é¢çš„ä¿¡æ¯ï¼š</p>
            <ul>
              <li>å…¬å¸ä¸šåŠ¡ä»‹ç»ï¼ˆè½¯ä»¶å¼€å‘ã€å©šæ‹æœåŠ¡ã€åŒ»è¯æ‹›å•†ï¼‰</li>
              <li>OAç³»ç»ŸåŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•</li>
              <li>å‘˜å·¥æ‰‹å†Œå’Œå…¬å¸æ”¿ç­–</li>
              <li>å…¶ä»–å·¥ä½œç›¸å…³é—®é¢˜</li>
            </ul>
          </div>
          <p class="text-xs text-neutral-400 mt-1">åˆšåˆš</p>
        </div>
      </div>
    </div>
    
    <div class="p-4 border-t border-gray-200">
      <div class="relative">
        <input id="message-input" type="text" placeholder="è¾“å…¥é—®é¢˜æˆ–æŒ‡ä»¤..." class="w-full pl-4 pr-12 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors">
        <button id="send-message" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-primary text-white p-2 rounded-full hover:bg-primary/90 transition-colors">
          <i class="fa fa-paper-plane"></i>
        </button>
      </div>
      <p class="text-xs text-neutral-400 mt-2">è¾“å…¥ "å¸®åŠ©" æŸ¥çœ‹å¯ç”¨å‘½ä»¤</p>
    </div>
  </div>
  
  <script>
    // DeepSeek API èŠå¤©ç±»
    class DeepSeekChat {
      constructor(apiKey) {
        this.apiKey = apiKey;
        this.apiUrl = 'https://api.deepseek.com/v1/chat/completions';
        this.headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.apiKey}`
        };
        this.messages = [];
      }
      
      // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
      setSystemMessage(content) {
        this.messages.push({
          role: 'system',
          content: content
        });
      }
      
      // å‘é€ç”¨æˆ·æ¶ˆæ¯å¹¶è·å–å›å¤
      async sendMessage(content, onMessageUpdate) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
        this.messages.push({
          role: 'user',
          content: content
        });
        
        try {
          const response = await fetch(this.apiUrl, {
            method: 'POST',
            headers: this.headers,
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: this.messages,
              temperature: 0.7,
              stream: true // å¯ç”¨æµå¼å“åº”
            })
          });
          
          if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
          }
          
          // å¤„ç†æµå¼å“åº”
          return this._handleStreamResponse(response, onMessageUpdate);
        } catch (error) {
          console.error('DeepSeek API é”™è¯¯:', error);
          throw error;
        }
      }
      
      // å¤„ç†æµå¼å“åº”
      async _handleStreamResponse(response, onMessageUpdate) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let accumulatedText = '';
        
        return new Promise((resolve, reject) => {
          const readLoop = async () => {
            try {
              while (true) {
                const { done, value } = await reader.read();
                if (done) {
                  // æ·»åŠ AIå›å¤åˆ°å¯¹è¯å†å²
                  this.messages.push({
                    role: 'assistant',
                    content: accumulatedText
                  });
                  resolve(accumulatedText);
                  return;
                }
                
                // å¤„ç†æ•°æ®å—
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n').filter(line => line.trim() !== '');
                
                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    const data = line.substring(6);
                    if (data === '[DONE]') continue;
                    
                    try {
                      const parsed = JSON.parse(data);
                      if (parsed.choices && parsed.choices[0].delta.content) {
                        accumulatedText += parsed.choices[0].delta.content;
                        // è°ƒç”¨å›è°ƒå‡½æ•°æ›´æ–°UI
                        if (typeof onMessageUpdate === 'function') {
                          onMessageUpdate(accumulatedText);
                        }
                      }
                    } catch (e) {
                      console.error('è§£ææµæ•°æ®å¤±è´¥:', e);
                    }
                  }
                }
              }
            } catch (error) {
              console.error('è¯»å–æµå¤±è´¥:', error);
              reject(error);
            }
          };
          
          readLoop();
        });
      }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šå°†æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œæ ‡ç­¾
    function formatMessage(text) {
      if (!text) return '';
      // ç®€å•çš„Markdownè§£æï¼šæ¢è¡Œç¬¦è½¬<br>ï¼Œåˆ—è¡¨è§£æï¼Œç²—ä½“è§£æ
      let formatted = text
        // è½¬æ¢æ¢è¡Œç¬¦
        .replace(/\n/g, '<br>')
        // è½¬æ¢æ— åºåˆ—è¡¨
        .replace(/^\s*-\s+(.*)$/gm, '<li>$1</li>')
        // è½¬æ¢æœ‰åºåˆ—è¡¨
        .replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>')
        // è½¬æ¢æ ‡é¢˜
        .replace(/^#\s+(.*)$/gm, '<h4 class="font-semibold mb-1">$1</h4>')
        .replace(/^##\s+(.*)$/gm, '<h5 class="font-medium mb-1">$1</h5>')
        // è½¬æ¢ç²—ä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // è½¬æ¢é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
      
      // å°†åˆ—è¡¨é¡¹åŒ…è£…åœ¨<ul>æˆ–<ol>ä¸­
      formatted = formatted
        .replace(/(<li>.*?<\/li>)+/gs, '<ul class="list-disc pl-5 mb-2">$&</ul>')
        .replace(/<ul>(\s*<li>.*?<\/li>\s*)+<\/ul>/gs, (match) => {
          // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰åºåˆ—è¡¨
          if (match.includes('<li>1.')) {
            return match.replace('<ul>', '<ol class="list-decimal pl-5 mb-2">');
          }
          return match;
        });
      
      return formatted;
    }
    
    // èŠå¤©UIåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const chatWindow = document.getElementById('chat-window');
      const closeChat = document.getElementById('close-chat');
      const messageInput = document.getElementById('message-input');
      const sendMessage = document.getElementById('send-message');
      const chatMessages = document.getElementById('chat-messages');
      const toggleFullscreen = document.getElementById('toggle-fullscreen');
      let isFullscreen = true;
      
      // åˆå§‹åŒ–DeepSeekèŠå¤©å®ä¾‹
      const chat = new DeepSeekChat('sk-bffc53706f39422e8c0b989178bb676a');
      chat.setSystemMessage(`ä½ æ˜¯ä½³æœ¨æ–¯æ³½æ¶¦ä¹ç¦ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸çš„AIåŠ©æ‰‹ï¼Œå…¬å¸ä¸»è¦ä»äº‹è½¯ä»¶å¼€å‘ã€å©šæ‹ä»‹ç»å’Œè¯ç¦åŒ»è¯æ‹›å•†ç½‘ç­‰æœåŠ¡ã€‚ä½ éœ€è¦å¸®åŠ©å‘˜å·¥è§£å†³å·¥ä½œç›¸å…³é—®é¢˜ï¼Œæä¾›å…¬å¸ä¸šåŠ¡ä¿¡æ¯å’ŒOAç³»ç»Ÿä½¿ç”¨æŒ‡å¯¼ã€‚è¯·ç®€æ´æ˜äº†åœ°å›ç­”é—®é¢˜ï¼Œå¹¶å°½é‡ä½¿ç”¨å‹å¥½çš„è¯­æ°”ï¼ŒåŠ¡å¿…æ³¨æ„ï¼šç¦æ­¢èƒ¡ç¼–ä¹±é€ ï¼Œä½ åªèƒ½æ ¹æ®å‘Šè¯‰ä½ çš„å†…å®¹è¿›è¡Œå›ç­”ï¼ŒçŸ¥é“çš„å†…å®¹å¦‚å®è¯´ï¼Œä¸çŸ¥é“çš„å†…å®¹æç¤ºè”ç³»äººäº‹éƒ¨ã€‚`);
      
      // å…³é—­èŠå¤©çª—å£
      closeChat.addEventListener('click', function() {
        // é€šçŸ¥çˆ¶çª—å£å…³é—­
        if (window.parent !== window) {
          window.parent.postMessage({ type: 'close-chat' }, '*');
        }
      });
      
      // åˆ‡æ¢å…¨å±æ¨¡å¼
      toggleFullscreen.addEventListener('click', function() {
        isFullscreen = !isFullscreen;
        
        if (isFullscreen) {
          // è¿›å…¥å…¨å±
          chatWindow.classList.add('fullscreen-chat');
          toggleFullscreen.innerHTML = '<i class="fa fa-compress"></i>';
        } else {
          // é€€å‡ºå…¨å±
          chatWindow.classList.remove('fullscreen-chat');
          toggleFullscreen.innerHTML = '<i class="fa fa-expand"></i>';
        }
      });
      
      // å‘é€æ¶ˆæ¯
      sendMessage.addEventListener('click', async function() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', message);
        messageInput.value = '';
        
        try {
          // åˆ›å»ºAIå›å¤å…ƒç´ å¹¶æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
          const aiMessageId = 'ai-message-' + Date.now();
          appendThinkingMessage(aiMessageId);
          
          // å‘é€æ¶ˆæ¯åˆ°APIå¹¶è·å–å›å¤
          await chat.sendMessage(message, (partialResponse) => {
            // æ›´æ–°AIå›å¤å†…å®¹
            updateAIMessage(aiMessageId, partialResponse);
          });
        } catch (error) {
          console.error('èŠå¤©è¿‡ç¨‹ä¸­å‡ºé”™:', error);
          appendMessage('error', 'æŠ±æ­‰ï¼Œå‘ç”Ÿé”™è¯¯: ' + error.message);
        }
      });
      
      // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage.click();
        }
      });
      
      // æ·»åŠ æ¶ˆæ¯åˆ°UI
      function appendMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = role === 'user' 
          ? 'flex items-start justify-end message-appear' 
          : 'flex items-start message-appear';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = role === 'user' 
          ? 'bg-primary text-white rounded-lg p-3 max-w-[80%] shadow-sm' 
          : role === 'error' 
            ? 'bg-red-50 text-red-800 rounded-lg p-3 max-w-[80%] shadow-sm'
            : 'bg-white rounded-lg p-3 max-w-[80%] shadow-sm';
        
        if (role === 'user') {
          contentDiv.innerHTML = `<p class="text-sm">${content}</p>
                            <p class="text-xs opacity-70 mt-1">åˆšåˆš</p>`;
        } else {
          contentDiv.innerHTML = `
            <div class="markdown-content">
              ${formatMessage(content)}
            </div>
            <p class="text-xs opacity-70 mt-1">åˆšåˆš</p>
          `;
        }
        
        const img = document.createElement('img');
        img.src = role === 'user' 
          ? 'https://picsum.photos/40/40?random=user' 
          : 'https://picsum.photos/40/40?random=ai';
        img.alt = role === 'user' ? 'ç”¨æˆ·å¤´åƒ' : 'AIåŠ©æ‰‹å¤´åƒ';
        img.className = 'w-8 h-8 rounded-full ' + (role === 'user' ? 'ml-2 mt-1' : 'mr-2 mt-1');
        
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(img);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // æ·»åŠ "æ­£åœ¨è¾“å…¥"æ¶ˆæ¯
      function appendThinkingMessage(id) {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.id = id;
        thinkingDiv.className = 'flex items-start message-appear';
        
        const img = document.createElement('img');
        img.src = 'https://picsum.photos/40/40?random=ai';
        img.alt = 'AIåŠ©æ‰‹å¤´åƒ';
        img.className = 'w-8 h-8 rounded-full mr-2 mt-1';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'bg-white rounded-lg p-3 max-w-[80%] shadow-sm';
        contentDiv.innerHTML = `
          <div class="markdown-content">
            <p>AIæ­£åœ¨æ€è€ƒ<span class="typing-indicator">...</span></p>
          </div>
        `;
        
        thinkingDiv.appendChild(img);
        thinkingDiv.appendChild(contentDiv);
        chatMessages.appendChild(thinkingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      
      // æ›´æ–°AIæ¶ˆæ¯å†…å®¹
      function updateAIMessage(id, content) {
        const messageDiv = document.getElementById(id);
        if (messageDiv) {
          const contentDiv = messageDiv.querySelector('div');
          if (contentDiv) {
            contentDiv.innerHTML = `
              <div class="markdown-content">
                ${formatMessage(content)}
              </div>
              <p class="text-xs opacity-70 mt-1">åˆšåˆš</p>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
      }
      
      // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
      window.addEventListener('message', function(event) {
        if (event.data.type === 'open-chat') {
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ‰“å¼€åŠ¨ç”»ç­‰
        }
      });
    });
  </script>
</body>
</html>